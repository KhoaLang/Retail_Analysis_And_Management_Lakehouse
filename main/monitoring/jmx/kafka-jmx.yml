# lowercaseOutputName: true
# rules:
#   - pattern: 'kafka.server<type=(.+), name=(.+)PerSec, topic=(.+)><>Count'
#     name: kafka_server_$1_$2_total
#     labels:
#       topic: "$3"
#     type: COUNTER

#   - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(.+)><>Count'
#     name: kafka_broker_topic_$1_total
#     type: COUNTER

#   - pattern: 'kafka.consumer<type=consumer-fetch-manager-metrics, client-id=(.+)><>records-lag-max'
#     name: kafka_consumer_records_lag_max
#     labels:
#       client_id: "$1"
#     type: GAUGE

lowercaseOutputName: true
lowercaseOutputLabelNames: true

rules:

  # =========================================================
  # üî• BROKER TOPIC THROUGHPUT (PER TOPIC)
  # =========================================================
  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(BytesInPerSec|BytesOutPerSec|MessagesInPerSec), topic=(.+)><>Count'
    name: kafka_broker_topic_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # =========================================================
  # üöÄ PRODUCER REQUESTS & FAILURES
  # =========================================================
  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(TotalProduceRequestsPerSec|FailedProduceRequestsPerSec), topic=(.+)><>Count'
    name: kafka_producer_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # =========================================================
  # üì• CONSUMER FETCH REQUESTS & FAILURES
  # =========================================================
  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(TotalFetchRequestsPerSec|FailedFetchRequestsPerSec), topic=(.+)><>Count'
    name: kafka_consumer_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # =========================================================
  # ‚è± REQUEST LATENCY (PRODUCE / FETCH)
  # =========================================================
  - pattern: 'kafka.network<type=RequestMetrics, name=(TotalTimeMs|RequestQueueTimeMs|LocalTimeMs), request=(Produce|FetchConsumer)><>Mean'
    name: kafka_request_latency_ms
    labels:
      request: "$2"
      metric: "$1"
    type: GAUGE

  # =========================================================
  # üê¢ CONSUMER LAG (PER CLIENT / TOPIC / PARTITION)
  # =========================================================
  - pattern: 'kafka.consumer<type=consumer-fetch-manager-metrics, client-id=(.+), topic=(.+), partition=(.+)><>records-lag'
    name: kafka_consumer_records_lag
    labels:
      client_id: "$1"
      topic: "$2"
      partition: "$3"
    type: GAUGE

  - pattern: 'kafka.consumer<type=consumer-fetch-manager-metrics, client-id=(.+)><>records-lag-max'
    name: kafka_consumer_records_lag_max
    labels:
      client_id: "$1"
    type: GAUGE

  # =========================================================
  # üö® BROKER THROTTLING & REJECTIONS
  # =========================================================
  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(BytesRejectedPerSec|ThrottledRequestsPerSec), topic=(.+)><>Count'
    name: kafka_broker_throttling_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # =========================================================
  # üß± REPLICATION & AVAILABILITY
  # =========================================================
  - pattern: 'kafka.server<type=ReplicaManager, name=UnderReplicatedPartitions><>Value'
    name: kafka_under_replicated_partitions
    type: GAUGE

  - pattern: 'kafka.server<type=ReplicaManager, name=OfflinePartitionsCount><>Value'
    name: kafka_offline_partitions
    type: GAUGE

  # =========================================================
  # üß† JVM MEMORY & GC (BROKER HEALTH)
  # =========================================================
  - pattern: 'java.lang<type=Memory><HeapMemoryUsage><used>'
    name: jvm_heap_used_bytes
    type: GAUGE

  - pattern: 'java.lang<type=Memory><HeapMemoryUsage><max>'
    name: jvm_heap_max_bytes
    type: GAUGE

  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><CollectionTime>'
    name: jvm_gc_collection_time_ms
    labels:
      gc: "$1"
    type: COUNTER

  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><CollectionCount>'
    name: jvm_gc_collection_count
    labels:
      gc: "$1"
    type: COUNTER

  # =========================================================
  # üßµ JVM THREADS
  # =========================================================
  - pattern: 'java.lang<type=Threading><ThreadCount>'
    name: jvm_threads_current
    type: GAUGE

  - pattern: 'java.lang<type=Threading><DaemonThreadCount>'
    name: jvm_threads_daemon
    type: GAUGE

  - pattern: 'java.lang<type=Threading><PeakThreadCount>'
    name: jvm_threads_peak
    type: GAUGE
